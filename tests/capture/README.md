# PyShark Capture Tests

This directory contains tests for PyShark capture functionality including basic captures, live captures, enhanced captures, and integration tests.

## Test Files

### Core Capture Tests
- `test_capture.py` - Basic capture functionality tests
- `test_live_capture.py` - Live network interface capture tests  
- `test_inmem_capture.py` - In-memory capture handling tests

### Enhanced Capture Tests
- `test_enhanced_file_capture.py` - Enhanced file capture capabilities
- `test_integration_enhanced_capture.py` - Integration tests for enhanced features

## Test Coverage

### Basic Capture Functionality
```python
# File capture tests
def test_file_capture_basic():
    """Test basic file capture functionality"""
    
def test_file_capture_with_filter():
    """Test file capture with display filters"""
    
def test_file_capture_packet_access():
    """Test packet access and iteration"""

# Live capture tests  
def test_live_capture_interface():
    """Test live capture from network interface"""
    
def test_live_capture_timeout():
    """Test live capture with timeout"""
```

### Enhanced Capture Features
```python
# Enhanced file capture tests
def test_enhanced_security_analysis():
    """Test security analysis capabilities"""
    
def test_enhanced_performance_monitoring():
    """Test performance monitoring features"""
    
def test_enhanced_web_analysis():
    """Test web traffic analysis"""

# Integration tests
def test_multi_protocol_analysis():
    """Test analysis across multiple protocols"""
    
def test_custom_field_extraction():
    """Test custom field extraction capabilities"""
```

## Running Capture Tests

### Run All Capture Tests
```bash
cd tests/capture/
python -m pytest . -v

# Expected output:
# test_capture.py::test_file_capture_basic PASSED
# test_capture.py::test_file_capture_with_filter PASSED
# test_enhanced_file_capture.py::test_security_analysis PASSED
# test_enhanced_file_capture.py::test_performance_monitoring PASSED
# test_live_capture.py::test_live_capture_basic PASSED
```

### Run Specific Test Categories
```bash
# Basic capture tests only
python -m pytest test_capture.py -v

# Enhanced capture tests only
python -m pytest test_enhanced_file_capture.py -v

# Live capture tests (requires network interface)
python -m pytest test_live_capture.py -v

# Integration tests
python -m pytest test_integration_enhanced_capture.py -v
```

### Run with Coverage
```bash
python -m pytest . --cov=pyshark.capture --cov-report=html
```

## Test Requirements

### Test Data
Tests use PCAP files from `../data/`:
- `ethernet_test.pcap` - Ethernet protocol tests
- `wireless_test.pcap` - Wireless protocol tests
- `bluetooth_test.pcap` - Bluetooth protocol tests

### Generate Test Data
```bash
cd ../data/
python generate_ethernet_test.py
python generate_wireless_test.py
python generate_bluetooth_test.py
```

### System Requirements
- **TShark Installation**: Required for all capture tests
- **Network Interface**: Required for live capture tests (optional)
- **Test PCAP Files**: Generated by test data scripts
- **Permissions**: May require elevated permissions for live capture

## Test Configuration

### Capture Test Settings
```python
# Test configuration
CAPTURE_TEST_CONFIG = {
    'test_data_dir': '../data/',
    'ethernet_test_file': 'ethernet_test.pcap',
    'wireless_test_file': 'wireless_test.pcap',
    'bluetooth_test_file': 'bluetooth_test.pcap',
    'live_interface': 'eth0',  # Platform-specific
    'capture_timeout': 5,      # Seconds
    'max_test_packets': 100    # Limit for live tests
}
```

### Mock Configuration
```python
# Mock TShark for isolated testing
@pytest.fixture
def mock_tshark():
    """Mock TShark execution for unit tests"""
    with patch('pyshark.tshark.tshark.get_process_result') as mock:
        mock.return_value.stdout = sample_xml_output
        mock.return_value.returncode = 0
        yield mock
```

## Test Examples

### Basic File Capture Test
```python
def test_file_capture_basic():
    """Test basic file capture functionality"""
    import pyshark
    
    # Test file capture creation
    cap = pyshark.FileCapture('tests/data/ethernet_test.pcap')
    
    # Test packet iteration
    packet_count = 0
    for packet in cap:
        packet_count += 1
        assert packet.length > 0
        assert len(packet.layers) > 0
        
        if packet_count >= 5:  # Limit test packets
            break
    
    cap.close()
    assert packet_count > 0
```

### Enhanced Capture Test
```python
def test_enhanced_security_analysis():
    """Test enhanced security analysis capabilities"""
    from pyshark.capture import EnhancedFileCapture
    
    # Create enhanced capture
    cap = EnhancedFileCapture('tests/data/ethernet_test.pcap')
    
    # Test security analyzer
    security_analyzer = cap.create_security_analyzer(
        detect_suspicious_traffic=True,
        analyze_failed_connections=True
    )
    
    # Validate security analysis
    findings = security_analyzer.get_security_findings()
    assert isinstance(findings, list)
    
    # Test performance analyzer
    perf_analyzer = cap.create_performance_analyzer(
        timing_fields=['tcp.time_delta'],
        slow_threshold=0.1
    )
    
    metrics = perf_analyzer.get_performance_metrics()
    assert 'avg_rtt' in metrics or 'packet_count' in metrics
```

### Live Capture Test
```python
@pytest.mark.skipif(not has_network_interface(), 
                   reason="No network interface available")
def test_live_capture_basic():
    """Test basic live capture functionality"""
    import pyshark
    
    # Create live capture with timeout
    cap = pyshark.LiveCapture(interface='eth0')
    
    # Capture packets with timeout
    cap.sniff(timeout=2, packet_count=5)
    
    # Validate captured packets
    assert len(cap) > 0
    
    for packet in cap:
        assert packet.length > 0
        assert len(packet.layers) > 0
        break  # Test first packet only
```

## Integration Testing

### Multi-Protocol Analysis Test
```python
def test_multi_protocol_analysis():
    """Test analysis across multiple protocol files"""
    from pyshark.capture import SuperEnhancedCapture
    
    # Multi-file analysis
    files = [
        'tests/data/ethernet_test.pcap',
        'tests/data/wireless_test.pcap',
        'tests/data/bluetooth_test.pcap'
    ]
    
    cap = SuperEnhancedCapture(files)
    
    # Test unified analysis
    protocol_summary = cap.get_protocol_summary()
    assert 'ethernet' in protocol_summary
    assert 'wireless' in protocol_summary
    assert 'bluetooth' in protocol_summary
    
    # Test cross-protocol flows
    flows = cap.analyze_cross_protocol_flows()
    assert isinstance(flows, list)
```

### Display Filter Integration Test
```python
def test_capture_with_display_filters():
    """Test capture integration with display filters"""
    from pyshark.display import EthernetFilters
    import pyshark
    
    # Get display filter
    ethernet_filters = EthernetFilters()
    broadcast_filter = ethernet_filters.get_filter('broadcast_frames')
    
    # Apply filter to capture
    cap = pyshark.FileCapture(
        'tests/data/ethernet_test.pcap',
        display_filter=broadcast_filter.filter_expression
    )
    
    # Validate filtered results
    for packet in cap:
        if 'ETH' in packet:
            # Should only contain broadcast frames
            assert packet.eth.dst == 'ff:ff:ff:ff:ff:ff'
```

## Error Handling Tests

### File Error Tests
```python
def test_file_not_found():
    """Test error handling for missing files"""
    import pyshark
    
    with pytest.raises(FileNotFoundError):
        cap = pyshark.FileCapture('nonexistent.pcap')
        list(cap)  # Force evaluation

def test_invalid_pcap_file():
    """Test error handling for invalid PCAP files"""
    import tempfile
    import pyshark
    
    # Create invalid file
    with tempfile.NamedTemporaryFile(suffix='.pcap', delete=False) as f:
        f.write(b'invalid pcap data')
        f.flush()
        
        with pytest.raises(Exception):
            cap = pyshark.FileCapture(f.name)
            list(cap)  # Force evaluation
```

### Interface Error Tests
```python
def test_invalid_interface():
    """Test error handling for invalid network interfaces"""
    import pyshark
    
    with pytest.raises(Exception):
        cap = pyshark.LiveCapture(interface='invalid_interface_name')
        cap.sniff(timeout=1)
```

## Performance Tests

### Large File Performance
```python
def test_large_file_performance():
    """Test performance with large PCAP files"""
    import time
    import pyshark
    
    start_time = time.time()
    
    cap = pyshark.FileCapture('tests/data/ethernet_test.pcap')
    packet_count = 0
    
    for packet in cap:
        packet_count += 1
        if packet_count >= 1000:  # Limit for performance test
            break
    
    end_time = time.time()
    processing_time = end_time - start_time
    
    # Performance assertions
    assert processing_time < 30  # Should complete within 30 seconds
    assert packet_count > 0
    
    packets_per_second = packet_count / processing_time
    print(f"Performance: {packets_per_second:.2f} packets/second")
```

## Continuous Integration

### CI Test Configuration
```yaml
# .github/workflows/capture_tests.yml
name: Capture Tests
on: [push, pull_request]
jobs:
  capture-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install TShark
        run: sudo apt-get install tshark
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install dependencies
        run: pip install -r requirements.txt pytest
      - name: Generate test data
        run: |
          cd tests/data
          python generate_ethernet_test.py
          python generate_wireless_test.py
          python generate_bluetooth_test.py
      - name: Run capture tests
        run: python -m pytest tests/capture/ -v
```

## See Also

- `../../src/pyshark/capture/` - Capture implementation modules
- `../data/` - Test data generation and PCAP files
- `../display/` - Display filter tests  
- `../packet/` - Packet parsing tests
- `test_enhanced_file_capture.py` - Enhanced capture feature tests